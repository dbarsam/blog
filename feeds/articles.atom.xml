<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>#Dev - articles</title><link href="https://dbarsam.github.io/blog/" rel="alternate"></link><link href="https://dbarsam.github.io/blog/feeds/articles.atom.xml" rel="self"></link><id>https://dbarsam.github.io/blog/</id><updated>2020-11-06T10:14:45+00:00</updated><subtitle>A collection of software development notes</subtitle><entry><title>Headless Qt?</title><link href="https://dbarsam.github.io/blog/headless-qt.html" rel="alternate"></link><published>2020-11-06T10:14:45+00:00</published><updated>2020-11-06T10:14:45+00:00</updated><author><name>db</name></author><id>tag:dbarsam.github.io,2020-11-06:/blog/headless-qt.html</id><summary type="html">&lt;p&gt;Can you configure Qt to work in systems with no UI?&lt;/p&gt;</summary><content type="html">&lt;p&gt;This isn't a real article.  Instead, it's more of an annotated bookmark of this &lt;a href="https://www.qcad.org/bugtracker/index.php?do=details&amp;amp;task_id=1534"&gt;post&lt;/a&gt;, which was used in some research on how to configure Qt applications to run in Docker Windows containers -- and that Docker task is part of another, work-in-progress project that may not ever be completed. So, there are no solutions here.  Sorry.&lt;/p&gt;
&lt;p&gt;The &lt;a href="https://www.qcad.org/bugtracker/index.php?do=details&amp;amp;task_id=1534"&gt;post&lt;/a&gt;, archived here, says this:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Since the launcher batch no longer requests "-style plastique" QT wants to apply the native style of the desktop environment. This fails on a headless system (or where the current user has no graphical shell to connect to) with the message "Gtk-WARNING **: cannot open display: ". Fortunately, QT provides a workaround in addition to the new "platform=offscreen" flag.&lt;/p&gt;
&lt;p&gt;In the tools that set &lt;em&gt;-no-gui&lt;/em&gt;, beforehand export these variables into the environment&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="go"&gt;export QT_STYLE_OVERRIDE=&amp;quot;&amp;quot;&lt;/span&gt;
&lt;span class="go"&gt;export QT_QPA_PLATFORM=offscreen&lt;/span&gt;
&lt;span class="go"&gt;export DISPLAY=&amp;quot;&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;PS: QT-offscreen will not find fonts; unfortunately the workaround only allows for a single directory to search them (I need helvetica):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="go"&gt;export QT_QPA_FONTDIR=&amp;quot;/usr/local/share/fonts/type1&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Maybe that should get reported upstream, so that like LD_LIBRARY_PATH several directories could be specified.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The post has some concepts that require some commentary, done here via unorganized bullet points:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;The solution should be as simple as setting the &lt;code&gt;QT_QPA_PLATFORM=offscreen&lt;/code&gt; variable setting. However, it's probably wishful thinking that Qt would make it that easy to disable the UI part of their UI framework.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;This post is for Linux, in case it's not obvious.  Windows does not support the &lt;code&gt;export&lt;/code&gt; command nor the &lt;code&gt;DISPLAY&lt;/code&gt; environment variable:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;The &lt;code&gt;export&lt;/code&gt; command does has an equivalent &lt;code&gt;set&lt;/code&gt; command.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The &lt;code&gt;DISPLAY&lt;/code&gt; variable is actually part of the &lt;code&gt;X server&lt;/code&gt; window system, which introduces an entirely different problem if you want this to work on Windows.  This is a awkward problem:  You have to either find the Windows equivalent or launch an X compatible window system, like &lt;a href="https://sourceforge.net/projects/vcxsrv/"&gt;vcxsrv&lt;/a&gt;, on top of your system -- but why would if you do that if your goal is a to run as headless application?&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The Qt library does provide a &lt;a href="https://doc.qt.io/qt-5/qoffscreensurface.html"&gt;QOffscreenSurface&lt;/a&gt; class but is it intended for cases common to &lt;a href="https://forum.qt.io/topic/56889/what-exactly-is-a-qoffscreensurface"&gt;OpenGL rendering&lt;/a&gt;.  Despite the name it does not seem applicable to the problem.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The Qt help page for &lt;a href="https://doc.qt.io/qt-5/qcoreapplication.html"&gt;QtCoreApplication&lt;/a&gt; describes it as the class for non-GUI applications:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;This class is used by non-GUI applications to provide their event loop. For non-GUI application that uses Qt, there should be exactly one QCoreApplication object. For GUI applications, see QGuiApplication. For applications that use the Qt Widgets module, see QApplication.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;But since we need the UI application to only be headless in certain situations it's unclear if this is really applicable.  Our goal is to seamlessly work in the different environments without having to add additional code to switch between &lt;code&gt;QApplication&lt;/code&gt; and &lt;code&gt;QCoreApplication&lt;/code&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Here's the unanswered &lt;a href="https://stackoverflow.com/questions/42686691/create-a-truly-headless-qapplication-instance"&gt;StackOverflow&lt;/a&gt; question asking the same thing.  One comment confirms that it worked with the &lt;a href="https://doc.qt.io/qt-5/qguiapplication.html#platformName-prop"&gt;offscreen&lt;/a&gt; setting.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</content><category term="articles"></category><category term="Python"></category><category term="Qt"></category><category term="Docker"></category><category term="GUI"></category></entry></feed>